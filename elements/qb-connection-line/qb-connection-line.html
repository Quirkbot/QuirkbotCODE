<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
(function () {
	Polymer({
		is: 'qb-connection-line',
		properties: {
			canvas: {
				type: Object,
				observer: '_canvasChanged'
			},
			source: {
				type: Object,
				observer: '_sourceChanged'
			},
			destination: {
				type: Object,
				observer: '_destinationChanged'
			}
		},
		line: null,
		commonParent: null,
		ready: function() {
			this.line = document.createElementNS("http://www.w3.org/2000/svg", "line");

		},
		detached: function() {
			if(typeof this.canvas !== 'undefined'){
				this.canvas.remove(this.line);
			}
			if(typeof this.source !== 'undefined'){
				this.removeDragListeners(this.source);
			}
			if(typeof this.destination !== 'undefined'){
				this.removeDragListeners(this.destination);
			}
		},
		sharesCommonParent: function(node){
			var parent = Polymer.dom(node).parentNode;
			if(!parent) return false;
			if(parent == this.commonParent)	return true;
			return this.sharesCommonParent(parent)
		},
		computePositionRelativeToCanvas: function(node, position){
			var boundingRect = node.getBoundingClientRect();
			var canvasBoundingRect = this.canvas.getBoundingClientRect();
			var position = {
				x:boundingRect.left + boundingRect.width/2 - canvasBoundingRect.left,
				y:boundingRect.top + boundingRect.height/2 - canvasBoundingRect.top
			};
			return position;
			/*
			if(node == this.commonParent) {
				var canvasBoundingRect = this.canvas.getBoundingClientRect();
				position.x -= canvasBoundingRect.left;
				position.y -= canvasBoundingRect.top;
				return position;
			};

			if(!position) position = {
				x:0,
				y:0
			};
			var boundingRect = node.getBoundingClientRect();
			console.log(node,boundingRect)
			position.x += boundingRect.left;
			position.y += boundingRect.top;


			if(node == this.commonParent) {
				var canvasBoundingRect = this.canvas.getBoundingClientRect();
				position.x -= canvasBoundingRect.left;
				position.y -= canvasBoundingRect.top;
				return position;
			};

			if(!position) position = {
				x:0,
				y:0
			};
			var boundingRect = node.getBoundingClientRect();
			console.log(node,boundingRect)
			position.x += boundingRect.left ;
			position.y += boundingRect.top;

			var parent = Polymer.dom(node).parentNode;
			if(parent) return this.computePositionRelativeToCanvas(parent, position)*/
		},
		addDragListeners: function(node){
			if(node == this.commonParent) return;
			if(node.QBDraggableBehavior){
				node.addEventListener('dragmove', this.postionUpdated.bind(this))
			}
			var parent = Polymer.dom(node).parentNode;
			if(parent) return this.addDragListeners(parent)
		},
		removeDragListeners: function(node){
			if(node == this.commonParent) return;
			if(node.QBDraggableBehavior){
				node.removeEventListener('dragmove', this.postionUpdated.bind(this))
			}
			var parent = Polymer.dom(node).parentNode;
			if(parent) return this.removeDragListeners(parent)
		},
		postionUpdated: function(e){
			if(typeof this.source === 'undefined'
				|| typeof this.destination === 'undefined'
				|| typeof this.canvas === 'undefined')
				return;

			var sourcePosition = this.computePositionRelativeToCanvas(this.source);
			var destinationPosition = this.computePositionRelativeToCanvas(this.destination);

			this.line.setAttributeNS(null, 'x1', sourcePosition.x);
			this.line.setAttributeNS(null, 'y1', sourcePosition.y);
			this.line.setAttributeNS(null, 'x2', destinationPosition.x);
			this.line.setAttributeNS(null, 'y2', destinationPosition.y);
		},
		_canvasChanged: function(canvas, oldCanvas){
			if(oldCanvas){
				oldCanvas.remove(this.line);
			}
			canvas.add(this.line);
			this.commonParent = Polymer.dom(canvas).parentNode;
			this.postionUpdated()
		},
		_sourceChanged: function(source, oldSource){
			console.log(source)
			if(oldSource){
				this.removeDragListeners(oldSource)
			}
			if(!this.sharesCommonParent(source)){
				console.warn('"qb-connection-line": "source" do not share a commonParent with "canvas".');
				return;
			}
			this.addDragListeners(source)
			this.postionUpdated()
		},
		_destinationChanged: function(destination, oldDestination){
			if(oldDestination){
				this.removeDragListeners(oldDestination)
			}
			if(!this.sharesCommonParent(destination)){
				console.warn('"qb-connection-line": "destination" do not share a commonParent with "canvas".');
				return;
			}
			this.addDragListeners(destination)
			this.postionUpdated()
		}
	});
})();
</script>
