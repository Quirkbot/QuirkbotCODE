<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../qb-behavior-self-property/qb-behavior-self-property.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<dom-module id="qb-core-auth">
	<template>
		<iron-ajax
			method="POST"
			url="[[tokenUrl]]"
			headers="[[tokenHeaders]]"
			id="tokenAjax">
		</iron-ajax>

		<iron-ajax
			id="apiAjax">
		</iron-ajax>

		<iron-localstorage
			name="qb-accessToken"
			value="{{accessToken}}">
		</iron-localstorage>
		<iron-localstorage
			name="qb-refreshToken"
			value="{{refreshToken}}">
		</iron-localstorage>
		<iron-localstorage
			name="qb-tokenExpires"
			value="{{expires}}">
		</iron-localstorage>

	</template>
</dom-module>
<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.CoreAuth = Polymer({
		is: 'qb-core-auth',
		properties: {
			authUrl: {
				type: String
			},
			apiUrl: {
				type: String
			},
			tokenUrl:{
				type: String,
				computed: '_computeTokenUrl(authUrl)'
			},
			tokenHeaders:{
				type: String,
				computed: '_computeTokenHeaders(clientId)'
			},
			clientId: {
				type: String
			},
			user: {
				type: String
			},
			password: {
				type: String
			},
			accessToken: {
				type: String,
				notify: true
			},
			refreshToken: {
				type: String,
				notify: true
			},
			expires: {
				type: Number,
				notify: true
			}
		},
		observers:[
			'authenticate(user, password)',
			'_scheduleRefresh(expires)'
		],
		behaviors:[
			window.Quirkbot.SelfPropertyBehavior
		],
		attached: function(){
			if(this.expires > Date.now() && this.accessToken && this.refreshToken){
				this.fire('authenticate', this);
			}
		},
		authenticate: function(user, password){
			this.$.tokenAjax.body = {
				'grant_type': 'password',
				'username' : user,
				'password': password
			};
			this._requestToken();
		},
		refresh: function(){
			this.$.tokenAjax.body = {
				'grant_type': 'refresh_token',
				'refresh_token' : this.refreshToken
			};
			this._requestToken();
		},
		apiCall: function (method, path, data) {
			return new Promise(function (resolve, reject) {
				this.$.apiAjax.headers = {
					'Content-Type' : 'application/x-www-form-urlencoded',
					'Authorization' : 'Bearer '+ this.accessToken
				};
				this.$.apiAjax.method = method;
				this.$.apiAjax.url = this.apiUrl + '/' + path;
				if(data){
					this.$.apiAjax.body = data;
				}
				this._request(this.$.apiAjax)
				.then(resolve)
				.catch(reject);
			});
		},
		_requestToken: function () {
			clearTimeout(this._scheduleRefreshTimer);
			this._request(this.$.tokenAjax)
			.then(function(response){
				// Annoying juggle to get around lint problems with underscore_names
				var accessTokenKey = 'access_token';
				this.accessToken = response[accessTokenKey];

				var refreshTokenKey = 'refresh_token';
				this.refreshToken = response[refreshTokenKey];

				var expiresKey = 'expires_in';
				this.expires = Date.now() + (response[expiresKey] * 1000);

				this.fire('authenticate', this);
			}.bind(this))
			.catch(function(error){
				this.fire('authenticate-error', error);
			}.bind(this));
		},
		_request: function (ajax) {
			return new Promise(function(resolve, reject) {
				var onResponse = function(e){
					clearTimeout(timer);
					ajax.removeEventListener('response', onResponse);
					resolve(e.detail.response);
				}.bind(this);
				ajax.addEventListener('response', onResponse);

				var onError = function(e){
					clearTimeout(timer);
					ajax.removeEventListener('error', onError);
					reject(e.detail.response);
				}.bind(this);

				ajax.addEventListener('error', onError);
				var timer = setTimeout(function(){
					request.abort();
				}.bind(this), 10000);
				var request = ajax.generateRequest();
			});
		},
		_computeTokenUrl: function(authUrl){
			return authUrl + '/token';
		},
		_computeTokenHeaders: function(clientId){
			return {
				'Content-Type' : 'application/x-www-form-urlencoded',
				'Authorization' : 'Basic '+ clientId
			};
		},
		_scheduleRefresh: function(expires, force){
			if(!expires && !force){
				return;
			}
			var delay;
			if(force){
				delay = 0;
			}
			else{
				var expiration = expires - 30000;
				if(expiration < Date.now()){
					delay = 0;
				}
				else{
					delay = expiration - Date.now();
				}
			}

			this._scheduleRefreshTimer =  setTimeout(this.refresh.bind(this), delay);
		}

	});
})();
</script>
