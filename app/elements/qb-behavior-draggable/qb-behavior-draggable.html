<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
(function () {
	
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot._DraggableBehaviorZIndex = 0;
	window.Quirkbot.DraggableBehavior = {
		DraggableBehavior: true,
		properties:{
			drag:{
				type: Boolean,
				notify: true,
				reflectToAttribute: true
			},
			data:{
				type: Object,
				value: {}
			}
		},
		observers: [
			'_positionChanged(data.visualX, data.visualY)'
		],
		listeners: {
			down: '_handleDown',
			track: '_handleTrack',
			touchmove: '_disableTouchScroll'
		},
		_handleDown: function(){
			this.style.zIndex = window.Quirkbot._DraggableBehaviorZIndex++;
		},
		_handleTrack: function(e) {
			if(!this.drag){
				return;
			}
			if(e.target !== this && e.target.drag){
				return;
			}
			if(this.trackEventFilter && this.trackEventFilter(e)){
				return;
			}

			switch(e.detail.state) {
				case 'start':
					this.fire('dragstart');
					
					break;
				case 'track':
					if(this.data){
						var x = this.data.visualX || 0;
						var y = this.data.visualY || 0;
						x += e.detail.ddx;
						y += e.detail.ddy;

						this.set('data.visualX', x);
						this.set('data.visualY', y);
					}
					this.fire('dragmove');
					break;
				case 'end':
					this.fire('dragend');
					break;
			}
		},
		_positionChanged: function(x,y){
			this.translate3d(x+'px', y+'px', 0);
		},
		/**
		 * We need to disable the touchstart event on this elements, otherwise
		 * when the user drags it, the whole screen will also be dragged on
		 * touch devices.
		 */
		_disableTouchScroll: function(e){
			e.preventDefault();
		}
	};
})();
</script>