<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../qb-behavior-utils/qb-behavior-utils.html">

<link rel="import" href="../qb-ui-nodes-menu-group/qb-ui-nodes-menu-group.html">

<dom-module id='qb-ui-nodes-menu'>
	<style>
		:host{
			display: block;
		}
	</style>
	<template>
		<template
			is="dom-repeat"
			items="{{categories}}"
			sort="sortByName"
			observe="name">
			<qb-ui-nodes-menu-group
				data="{{item}}">
			</qb-ui-nodes-menu-group>
		</template>
	</template>
</dom-module>
<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.UINodesMenu = Polymer({
		is: 'qb-ui-nodes-menu',
		properties: {
			taxonomyDefinitions: {
				type: Object
			},
			nodeDefinitions: {
				type: Array
			},
			categories:{
				type: Array
			},
			tags:{
				type: Array
			},
		},
		behaviors:[
			window.Quirkbot.UtilsBehavior
		],
		observers:[
			'_computeCategoriesAndTags(taxonomyDefinitions, nodeDefinitions)'
		],
		_computeCategoriesAndTags: function(taxonomyDefinitions, nodeDefinitions) {
			if(typeof nodeDefinitions === 'undefined' || typeof taxonomyDefinitions === 'undefined' ){
				return;
			}
			var nodesByCategory = {};
			var nodesByTags = {};
			this._taxonomyPush(nodeDefinitions, nodesByCategory, 'categories');
			this._taxonomyPush(nodeDefinitions, nodesByTags, 'tags');

			this.categories = [];
			taxonomyDefinitions.categories.forEach(function (definition) {
				var nodes = nodesByCategory[definition._id];
				this.push('categories', {
					definition: definition,
					nodes: nodes
				});
			}.bind(this));
		},
		_taxonomyPush: function (list, container, type) {
			list.forEach(function (node) {
				node.taxonomy[type].forEach(function (key) {
					if(!container[key]){
						container[key] = [];
					}
					container[key].push({
						definition: node
					});
				});
			});
		}
	});
})();
</script>
