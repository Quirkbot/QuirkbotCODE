<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">

<link rel="import" href="../qb-behavior-utils/qb-behavior-utils.html">

<link rel="import" href="../qb-ui-nodes-menu-group/qb-ui-nodes-menu-group.html">
<link rel="import" href="../qb-ui-nodes-menu-tag/qb-ui-nodes-menu-tag.html">

<dom-module id='qb-ui-nodes-menu'>
	<style>
		:host{
			display: block;
			overflow-y: scroll;
		}
	</style>
	<template>
		<template
			is="dom-repeat"
			items="{{categories}}"
			sort="sortByName"
			observe="name">
			<qb-ui-nodes-menu-group
				tree-manager="{{treeManager}}"
				drop-area="{{dropArea}}"
				visual-editor="{{visualEditor}}"
				data="{{item}}"
				tags="{{selectedTags}}">
			</qb-ui-nodes-menu-group>
		</template>
	</template>
</dom-module>
<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.UINodesMenu = Polymer({
		is: 'qb-ui-nodes-menu',
		properties: {
			dropArea: Object,
			visualEditor: Object,
			treeManager: Object,
			nodeDefinitions: Array,
			taxonomyDefinitions: Object,

			categories: Array,
			tags: Array,
			selectedTags: Array
		},
		behaviors:[
			window.Quirkbot.UtilsBehavior
		],
		observers:[
			'_computeCategoriesAndTags(taxonomyDefinitions, nodeDefinitions)'
		],
		_computeCategoriesAndTags: function(taxonomyDefinitions, nodeDefinitions) {
			if(typeof nodeDefinitions === 'undefined' || typeof taxonomyDefinitions === 'undefined' ){
				return;
			}
			var nodesByCategory = {};
			var nodesByTags = {};
			this._taxonomyPush(nodeDefinitions, nodesByCategory, 'categories');
			this._taxonomyPush(nodeDefinitions, nodesByTags, 'tags');

			this.categories = [];
			taxonomyDefinitions.categories.forEach(function (definition) {
				var nodes = nodesByCategory[definition._id];
				this.push('categories', {
					definition: definition,
					nodes: nodes
				});
			}.bind(this));

			this.tags = [];
			this.selectedTags = [];
			taxonomyDefinitions.tags.forEach(function (definition) {
				this.push('tags', {
					definition: definition
				});
				this.push('selectedTags',definition._id);
			}.bind(this));
		},
		_taxonomyPush: function (list, container, type) {
			list.forEach(function (node) {
				node.taxonomy[type].forEach(function (key) {
					if(!container[key]){
						container[key] = [];
					}
					container[key].push({
						definition: node
					});
				});
			});
		}
	});
})();
</script>
