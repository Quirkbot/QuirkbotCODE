<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../qb-core-i18n/qb-core-i18n.html">
<link rel="import" href="../qb-core-auth/qb-core-auth.html">
<link rel="import" href="../qb-core-router/qb-core-router.html">
<link rel="import" href="../qb-ui-email-confirmation/qb-ui-email-confirmation.html">
<link rel="import" href="../qb-ui-styles/qb-ui-styles.html">
<link rel="import" href="../qb-ui-icons/qb-ui-icons.html">
<link rel="import" href="../qb-ui-avatar/qb-ui-avatar.html">

<dom-module id='qb-app-user'>
	<template>
		<style include="qb-app-page-styles"></style>
		<style>
			:host{
				display: block;
			}

		</style>

		<qb-core-i18n
			url-format="[[stringsUrl]]"
			locale="[[locale]]">
		</qb-core-i18n>

		<qb-core-router
			entry="{{userNickname}}">
		</qb-core-router>

		<qb-core-auth
			id="auth"
			api-url="[[apiUrl]]"
			client-id="[[clientId]]"
			user={{user}}
			on-authenticate="_onAutheticate"
			on-authenticate-error="_onAutheticateError">
		</qb-core-auth>

		<paper-header-panel
			mode="scroll">
			<paper-toolbar>
				<iron-image
					class="quirkbot-logo"
					sizing="contain"
					src="[[resolveUrl('../../images/logo/white-outline.svg')]]">
				</iron-image>

				<div class="editor-mode layout vertical">
					<iron-image
						class="code"
						sizing="contain"
						src="[[resolveUrl('../../images/logo/code.svg')]]">
					</iron-image>

				</div>

				<div class="flex"></div>

				<qb-ui-avatar
					home-url="[[homeUrl]]"
					register-app-url="[[registerAppUrl]]"
					user-app-url="[[userAppUrl]]"
					program-app-url="[[programAppUrl]]"
					user="[[user]]">
				</qb-ui-avatar>
			</paper-toolbar>
			<div class="app-main">
				<div class="app-content">
					<template
						is="dom-if"
						if="[[_notAuthenticated]]">
						<h1>
							<qb-core-i18n
								key="ide/user/forbidden/title"></qb-core-i18n>
						</h1>
						<div>
							<qb-core-i18n
								key="ide/user/forbidden/description"></qb-core-i18n>
						</div>
					</template>
					<template
						is="dom-if"
						if="[[!_notAuthenticated]]">

						<qb-ui-email-confirmation
							user="[[user]]"
							on-resend-confirmation-requested='_resendConfirmation'>
						</qb-ui-email-confirmation>

						<template
							is="dom-if"
							if="[[_userNotFound]]">
							<h1>
								<qb-core-i18n
									key="ide/user/not-found/title"></qb-core-i18n>
							</h1>
							<div>
								<qb-core-i18n
									key="ide/user/not-found/description"></qb-core-i18n>
							</div>
						</template>

						<template
							is="dom-if"
							if="[[!_userNotFound]]">
							<h1>[[_userModel.nickname]]</h1>

							<h2>
								<qb-core-i18n
									key="ide/user/programs/title"></qb-core-i18n>
							</h2>

							<template
								is="dom-if"
								if="[[!_programsModel.length]]">
								<qb-core-i18n
									key="ide/user/programs/empty"></qb-core-i18n>
							</template>

							<template
								is="dom-repeat"
								items="[[_programsModel]]">
							</template>

							<template
								is="dom-if"
								if="[[_ownsProfile]]">
								<a href="[[programAppUrl]]">
									<paper-button>
										<qb-core-i18n
											key="ide/user/programs/create-new"></qb-core-i18n>
									</paper-button>
								</a>
							</template>
						</template>
					</template>
				</div>
				<div class="app-footer">
					Footer
				</div>
			</div>

		</paper-header-panel>

	</template>
</dom-module>

<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.AppUser = Polymer({
		is: 'qb-app-user',
		properties: {
			locale: String,
			clientId: String,
			chromeWebstoreId: String,
			compilerUrl: String,
			apiUrl: String,
			homeUrl: String,
			programAppUrl: String,
			registerAppUrl: String,
			userAppUrl: String,
			nodesUrl: String,
			stringsUrl: String,

			user:Object,

			userNickname: {
				type: String,
				observer: '_fetchUserModel'
			},

			_userModel: {
				type: Object,
				observer: '_fetchProgramsModel'
			},
			_programsModel:  {
				type: Array
			},
			_ownsProfile: {
				type: Boolean,
				computed: '_computeOwnsProfile(user, _userModel)'
			},
			_notAuthenticated: {
				type: Boolean
			}
		},
		observers:[
		],
		_onAutheticate: function(){
			this._notAuthenticated = false;
		},
		_onAutheticateError: function(){
			this._notAuthenticated = true;
		},
		_fetchUserModel: function(){
			return new Promise(function(resolve, reject){
				this.$.auth.apiCall('GET', 'user/?nickname=' + this.userNickname)
				.then(function (users) {
					if(users.length === 1){
						this._userModel = users[0];
						this._userNotFound = false;
						resolve(this._userModel);
					}
					else{
						this._userModel = null;
						this._userNotFound = true;
						reject('No single user in response');
					}
				}.bind(this))
				.catch(reject);
			}.bind(this));
		},
		_fetchProgramsModel: function(){
			return new Promise(function(resolve, reject){
				if(!this._userModel || !this._userModel.id){
					return reject('No user defined, cant get programs.');
				}
				this.$.auth.apiCall('GET', 'program/?author=' + this._userModel.id)
				.then(function (programs) {
					this._programsModel = programs;
				}.bind(this))
				.catch(reject);
			}.bind(this));
		},
		_computeOwnsProfile: function(user, _userModel){
			if(!user || !_userModel){
				return false;
			}

			return user.id === _userModel.id;
		}
	});
})();
</script>
