<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../qb-core-i18n/qb-core-i18n.html">
<link rel="import" href="../qb-core-auth/qb-core-auth.html">
<link rel="import" href="../qb-core-router/qb-core-router.html">
<link rel="import" href="../qb-behavior-utils/qb-behavior-utils.html">
<link rel="import" href="../qb-ui-app-container/qb-ui-app-container.html">
<link rel="import" href="../qb-ui-account-verification-reminder/qb-ui-account-verification-reminder.html">
<link rel="import" href="../qb-ui-styles/qb-ui-styles.html">
<link rel="import" href="../qb-ui-icons/qb-ui-icons.html">
<link rel="import" href="../qb-ui-app-container/qb-ui-app-container-styles.html">


<dom-module id='qb-app-user'>
	<template>
		<style include="qb-app-container-styles"></style>
		<style>
			.user-header{
				text-align: center;
				@apply(--layout-horizontal);
				@apply(--layout-center-justified);
				margin-bottom: 1rem;
			}
			.user-header .icon{
				display: block;
				--iron-icon-width: 4rem;
				--iron-icon-height: 4rem;
			}
			.user-header .label{
				display: block;
				color: var(--qb-pink);
				font-size: 2.5rem;
				margin-left: 0.5rem;
			}
			.description{
				text-align: center;
			}
			.description .label{
				font-weight: bold;
				font-size: 1.5rem;
			}
			.new-program-button{
				background: var(--qb-green);
			    color: var(--qb-white);
			}
			.program-item{
				border-radius: 10px;
				border: 1px solid var(--qb-grey-light-transparent);
				padding: 10px 20px;
			}

		</style>

		<qb-core-i18n
			url-format="[[stringsUrl]]"
			locale="[[locale]]">
		</qb-core-i18n>

		<qb-core-router
			entry="{{userNickname}}">
		</qb-core-router>

		<qb-core-auth
			id="auth"
			api-url="[[apiUrl]]"
			client-id="[[clientId]]"
			user={{user}}
			on-authenticate="_onAutheticate"
			on-authenticate-error="_onAutheticateError">
		</qb-core-auth>

		<qb-ui-app-container
			home-url="[[homeUrl]]"
			register-app-url="[[registerAppUrl]]"
			user-app-url="[[userAppUrl]]"
			program-app-url="[[programAppUrl]]"
			user="[[user]]">

			<div class="content">
				<template
					is="dom-if"
					if="[[_notAuthenticated]]">
					<div class="user-header">
						<iron-icon
							class="icon"
							icon="[[resolveIconName('denied', 'qb-icons')]]">
						</iron-icon>
						<span class="label"><qb-core-i18n
							key="ide/user/forbidden/title"></span>
					</div>
					<div class="description">
						<qb-core-i18n
							key="ide/user/forbidden/description"></qb-core-i18n>
					</div>
				</template>
				<template
					is="dom-if"
					if="[[!_notAuthenticated]]">

					<qb-ui-account-verification-reminder
						user="[[user]]"
						on-resend-verification-requested='_resendVerification'>
					</qb-ui-account-verification-reminder>

					<template
						is="dom-if"
						if="[[_userNotFound]]">
						<div class="user-header">
							<iron-icon
								class="icon"
								icon="[[resolveIconName('question-mark', 'qb-icons')]]">
							</iron-icon>
							<span class="label"><qb-core-i18n
								key="ide/user/not-found/title"></span>
						</div>
						<div class="description">
							<qb-core-i18n
								key="ide/user/not-found/description"></qb-core-i18n>
						</div>
					</template>

					<template
						is="dom-if"
						if="[[!_userNotFound]]">

						<div class="user-header">
							<iron-icon
								class="icon"
								icon="[[resolveIconName('user', 'qb-icons')]]">
							</iron-icon>
							<span class="label">[[_userModel.nickname]]</span>
						</div>


						<div class="description">
							<template
								is="dom-if"
								if="[[_ownsProfile]]">
								<paper-button
									class="new-program-button"
									on-tap="_goToEmptyProgram">
									<iron-icon
										class="icon"
										icon="[[resolveIconName('add', 'qb-icons')]]">
									</iron-icon>
									<qb-core-i18n
										key="ide/user/programs/create-new"></qb-core-i18n>
								</paper-button>
							</template>

							<template
								is="dom-if"
								if="[[!_ownsProfile]]">
								<template
									is="dom-if"
									if="[[!_programsModel.length]]">
									<qb-core-i18n
										key="ide/user/programs/empty"></qb-core-i18n>
								</template>
							</template>

						</div>


						<template
							is="dom-repeat"
							items="[[_programsModel]]">
							<div class="program-item">
								<div>[[item.name]]</div>
								<div>[[_formatDate(item.updatedAt)]]</div>
							</div>
						</template>

					</template>
				</template>
			</div>
		</qb-ui-app-container>
	</template>
</dom-module>

<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.AppUser = Polymer({
		is: 'qb-app-user',
		behaviors:[
			window.Quirkbot.UtilsBehavior
		],
		properties: {
			locale: String,
			clientId: String,
			chromeWebstoreId: String,
			compilerUrl: String,
			apiUrl: String,
			homeUrl: String,
			programAppUrl: String,
			registerAppUrl: String,
			userAppUrl: String,
			nodesUrl: String,
			stringsUrl: String,

			user:Object,

			userNickname: {
				type: String,
				observer: '_fetchUserModel'
			},

			_userModel: {
				type: Object,
				observer: '_fetchProgramsModel'
			},
			_programsModel:  {
				type: Array
			},
			_ownsProfile: {
				type: Boolean,
				computed: '_computeOwnsProfile(user, _userModel)'
			},
			_notAuthenticated: {
				type: Boolean
			}
		},
		observers:[
		],
		_onAutheticate: function(){
			this._notAuthenticated = false;
		},
		_onAutheticateError: function(){
			this._notAuthenticated = true;
		},
		_fetchUserModel: function(){
			return new Promise(function(resolve, reject){
				this.$.auth.apiCall('GET', 'user/?nickname=' + this.userNickname)
				.then(function (users) {
					if(users.length === 1){
						this._userModel = users[0];
						this._userNotFound = false;
						resolve(this._userModel);
					}
					else{
						this._userModel = null;
						this._userNotFound = true;
						reject('No single user in response');
					}
				}.bind(this))
				.catch(reject);
			}.bind(this));
		},
		_fetchProgramsModel: function(){
			return new Promise(function(resolve, reject){
				if(!this._userModel || !this._userModel.id){
					return reject('No user defined, cant get programs.');
				}
				this.$.auth.apiCall('GET', 'program/?author=' + this._userModel.id)
				.then(function (programs) {
					this._programsModel = programs;
				}.bind(this))
				.catch(reject);
			}.bind(this));
		},
		_computeOwnsProfile: function(user, _userModel){
			if(!user || !_userModel){
				return false;
			}

			return user.id === _userModel.id;
		},
		_goToEmptyProgram: function () {
			window.location = this.programAppUrl;
		},
		_formatDate: function (date) {
			//var d = new Date(date);
			//return d.getDate() + 
			return new Date(date);
		}
	});
})();
</script>
