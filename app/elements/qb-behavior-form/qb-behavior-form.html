<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.FormBehavior = {
		FormBehavior: true,
		properties: {
			action: {
				type: String
			},
			goTo: {
				type: String
			}
		},
		listeners:{
			'iron-form-submit' : '_onIronFormSubmit',
			'iron-form-response' : '_onIronFormResponse',
			'iron-form-error' : '_onIronFormError'
		},
		_submitForm: function(){
			this.$.form.submit();
		},
		_onIronFormSubmit: function(){
			this.loading = true;
		},
		_onIronFormResponse: function(e){
			this.loading = false;
			this.fire('response', e.detail);
			var params = {};
			window.location.search.slice(1).split('&').forEach(function (o) {
				o = o.split('=');
				params[o[0]] = o[1];
			});
			if(params.goto){
				window.location = params.goto;
				return;
			}
			if(this.goTo){
				window.location = this.goTo + '#/' + e.detail.id;
				return;
			}


		},
		_onIronFormError: function(e){
			this.loading = false;
			var apiError;
			try{
				apiError = e.detail.request.xhr.response;
			}
			catch(e){
				console.error(e);
			}
			if(apiError.error === 'E_VALIDATION' && typeof apiError.invalidAttributes === 'object'){
				Object.keys(apiError.invalidAttributes).forEach(function (id) {
					var field = this.$[id];
					if(!field) {
						return;
					}
					field.apiErrors = [];
					this.async(function () {
						field.apiErrors = apiError.invalidAttributes[id];
					});

				}.bind(this));
			}
			this.fire('error', e.detail);
		},
		_exactMatchRegex: function (str) {
			var scaped = str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, '\\$&');
			return '^'+scaped+'$';
		}

	};
})();
</script>
