<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">


<link rel="import" href="../qb-core-i18n/qb-core-i18n.html">
<link rel="import" href="../qb-core-auth/qb-core-auth.html">
<link rel="import" href="../qb-ui-styles/qb-ui-styles.html">
<link rel="import" href="../qb-ui-icons/qb-ui-icons.html">
<link rel="import" href="../qb-ui-registration-form/qb-ui-registration-form.html">
<link rel="import" href="../qb-ui-login-form/qb-ui-login-form.html">

<dom-module id='qb-app-register'>
	<style>
		:host{
			display: block;
		}

	</style>
	<template>

		<qb-core-i18n
			url-format="[[stringsUrl]]"
			locale="[[locale]]">
		</qb-core-i18n>

		<qb-core-auth
			id="auth"
			auth-url="[[authUrl]]"
			api-url="[[apiUrl]]"
			client-id="[[clientId]]"
			on-authenticate="_onAuthenticate">
		</qb-core-auth>

		<iron-localstorage
			name="qb-user"
			value="{{user}}">
		</iron-localstorage>

		<h2>
			<paper-button
				on-tap='_onResgisterCallToActionTap'>
				<qb-core-i18n
					key="register/registration/call-to-action"></qb-core-i18n>
			</paper-button>
		</h2>
		<iron-collapse
			id='registration-container'>
			<qb-ui-registration-form
				id="registration"
				action="[[_resolveApiUrl(apiUrl, 'user')]]">
			</qb-ui-registration-form>
		</iron-collapse>


		<h2>
			<paper-button
				on-tap='_onLoginCallToActionTap'>
				<qb-core-i18n
					key="register/login/call-to-action"></qb-core-i18n>
			</paper-button>
		</h2>
		<iron-collapse
			id='login-container'>
			<qb-ui-login-form
				id="login"
				cancel-submit
				on-submit="_onLoginSubmit"
				action="[[_resolveApiUrl(apiUrl, 'login')]]">
			</qb-ui-login-form>
		</iron-collapse>



	</template>
</dom-module>

<script>
(function () {
	window.Quirkbot = window.Quirkbot || {};
	window.Quirkbot.AppRegister = Polymer({
		is: 'qb-app-register',
		properties: {
			locale: {
				type: String,
				value: 'en_US'
			},
			clientId: {
				type: String,
				value: 'YWJjMTphc2Q='
			},
			authUrl: {
				type: String,
				value: 'http://localhost:8585/auth'
			},
			userAppUrl: {
				type: String,
				value: 'http://code.quirkbot.com/user'
			},
			apiUrl: {
				type: String,
				value: 'http://localhost:8585'
			},
			stringsUrl: {
				type: String,
				value: 'data/strings/{{locale}}.json'
			},
			user: {
				type: Object
			}
		},
		listeners:{
			'registration.response' : '_onRegistrationResponse',
			'login.response' : '_onLoginResponse'
		},
		ready: function(){

		},
		_onResgisterCallToActionTap: function () {
			this.$['registration-container'].toggle();
		},
		_onLoginCallToActionTap: function () {
			this.$['login-container'].toggle();
		},
		_onRegistrationResponse: function(e){
			this.$.registration.loading = true;
			this.user = e.detail;
			this.$.auth.authenticate(this.$.registration.nickname, this.$.registration.password);
		},
		_onLoginSubmit: function(){
			this.$.login.loading = true;
			this._nickname = this.$.login.nickname;

			// Try to authenticate directly, but if there is an error, use it
			// for feeback on the login form
			var onSuccess = function () {
				this.$.auth.removeEventListener('authenticate', onSuccess);
				this.$.auth.removeEventListener('authenticate-error', onError);
			}.bind(this);
			var onError = function (e) {
				this.$.auth.removeEventListener('authenticate', onSuccess);
				this.$.auth.removeEventListener('authenticate-error', onError);
				this.$.login.loading = false;
				this.$.login.errorCode = e.detail.code;
			}.bind(this);
			this.$.auth.addEventListener('authenticate', onSuccess);
			this.$.auth.addEventListener('authenticate-error', onError);

			this.$.auth.authenticate(this.$.login.nickname, this.$.login.password);
		},
		_onAuthenticate: function(){
			if(this.user && this.user.nickname){
				this._goToProfile();
			}
			else{
				this.$.auth.apiCall('GET', 'user/?nickname=' + this._nickname)
				.then(function (users) {
					if(users.length === 1){
						this.user = users[0];
						this._goToProfile();
					}
					else{
						console.log('Strange result getting user', users);
					}


				}.bind(this))
				.catch(function(){
					console.log('Error getting user', arguments);
				});
			}
		},
		_goToProfile: function(){
			var url = this.userAppUrl;
			if (url.charAt(url.length - 1) === '/') {
				url = url.substr(0, url.length - 1);
			}
			window.location = url + '#/' + this.user.nickname;
		},
		_resolveApiUrl: function(url, path){
			if (url.charAt(url.length - 1) === '/') {
				url = url.substr(0, url.length - 1);
			}
			return url + '/' + path;
		}

	});
})();
</script>
