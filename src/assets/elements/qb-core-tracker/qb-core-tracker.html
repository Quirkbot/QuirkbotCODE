<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">

<!--
Polymer Element for Google Analytics Universal Web Tracking, supports page and event tracking.

Initialise:

	<start-google-analytics-tracker code="UA-XXXXX-Y"></start-google-analytics-tracker>

Track an Event:

	this.fire('iron-signal', {name: 'track-event',data: {category: "messages",action: "send_text_message",label: "group",value: 1}});

Track a page Change:

	this.fire('iron-signal', {name: 'track-page', data: { path: "/about.html" } });

To use Google Analytics user id attribution https://developers.google.com/analytics/devguides/collection/analyticsjs/user-id set the user id property on the element:

	document.querySelector("start-google-analytics-tracker").userId = loggedInUserId;
-->
<dom-module id="qb-core-tracker">
	<template>
		<iron-signals
			on-iron-signal-track-user="_trackUser"
			on-iron-signal-track-page="_trackPage"
			on-iron-signal-track-event="_trackEvent">
		</iron-signals>
	</template>
</dom-module>
<script>

	/* jshint ignore:start */
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	/* jshint ignore:end */

	(function() {
		Polymer({
			is: 'qb-core-tracker',
			properties: {
				/**
				 * The Google analytics property id
				 */
				code: {
					type: String
				}
			},
			ready: function() {
				window.ga('create', this.code, 'auto');

				// Try to recover a  user from localStorage
				try{
					var userId = JSON.parse(localStorage.getItem('qb-user')).id;
					this._trackUser({detail: userId});
				}
				catch(e){}

				this.debounce('initial page', this._trackPage.bind(this), 500);
			},
			_trackEvent: function(e) {
				//Add support for a non-interactin even that does not effect bounce rates - eg things that happen after a timeout
				//ga('send', 'event', 'category', 'action', {'nonInteraction': 1});
				window.ga('send', 'event', e.detail.category, e.detail.action, e.detail.label, e.detail.value);

				console.log('_trackEvent', e.detail);
			},
			_trackPage: function(e) {
				//Use set param, this way if we then send a subsequent event on the page it will be correctly associated with the same page
				if (e !== undefined && e.detail.path !== undefined) {
					window.ga('set', 'page', e.detail.path);
				}
				if(e && e.detail){
					console.log('_trackPage', e.detail);
				}
				else{
					console.log('_trackPage', 'initial');
				}

				window.ga('send', 'pageview');
			},
			_trackUser: function(e) {
				console.log('_trackUser', e.detail);
				window.ga('set', '&uid', e.detail);
			}
		});
	})();
</script>
